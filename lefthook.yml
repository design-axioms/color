pre-commit:
  parallel: false
  commands:
    sync-lockfile:
      run: |
        echo "Ensuring lockfile is up to date..."
        if git diff --cached --name-only | grep -E '(^|/)package.json$|pnpm-workspace\.yaml$|pnpm-lock\.yaml$' >/dev/null; then
          CI=true pnpm install --lockfile-only --ignore-scripts --no-frozen-lockfile
          git add pnpm-lock.yaml
        else
          echo "No package manifest changes staged; skipping lockfile sync."
        fi
    format:
      glob: "*.{ts,js,json,md,yml,css,svelte,astro}"
      exclude: "dist/**/*"
      run: pnpm format {staged_files} && git add {staged_files}
    lint:
      glob: "*.{ts,js,svelte,astro}"
      exclude: "dist/**/*"
      run: pnpm eslint --fix {staged_files} && git add {staged_files}
    security:
      glob: "*"
      run: pnpm lint:security {staged_files}
    tokens:
      glob: "site/src/components/builder/**/*"
      run: pnpm lint:tokens
    docs:
      glob: "*.{md,mdx}"
      run: pnpm lint:docs
    knip:
      run: pnpm knip
    test:
      run: pnpm -r test

pre-push:
  parallel: false
  commands:
    sync-lockfile:
      run: |
        echo "Verifying pnpm-lock.yaml is up to date..."
        CI=true pnpm install --lockfile-only --ignore-scripts --no-frozen-lockfile
        if ! git diff --quiet -- pnpm-lock.yaml; then
          echo "pnpm-lock.yaml was updated by pnpm. Please commit the updated lockfile before pushing."
          git --no-pager diff -- pnpm-lock.yaml | head -n 200
          exit 1
        fi
    typecheck:
      run: tsc --noEmit && pnpm --filter @axiomatic-design/vscode-extension typecheck
    site-check:
      run: pnpm --filter site astro check && pnpm --filter site exec svelte-check
    build:
      run: bash scripts/hooks/hermetic-build.sh
    publint:
      run: pnpm check:exports
    lint-all:
      run: pnpm lint
    security-all:
      run: pnpm lint:security
