/*
 * RFC-029: Starlight CSS Integration Strategy
 * ============================================
 * 
 * This file implements the Axiomatic-Starlight adapter bridge following RFC-029.
 * The goal is to minimize `!important` usage while maintaining theme continuity.
 *
 * ARCHITECTURE
 * ------------
 * 1. **CSS Lock Pattern** (Variable Mappings): Uses `!important` on high-specificity
 *    selectors to prevent Starlight's late-loaded constructed stylesheets from
 *    reasserting `--sl-color-*` variables after our mappings load.
 *
 * 2. **Continuity Invariant**: Forces `color-scheme: light dark` to prevent
 *    discrete theme snaps during `--tau` transitions.
 *
 * 3. **Higher Specificity**: Most element/component overrides use increased
 *    selector specificity (e.g., `:root body .selector`) instead of `!important`.
 *
 * 4. **Route, Don't Remove**: Colors route through `var(--sl-color-*)` variables
 *    (which map to `--axm-bridge-*`), preserving Starlight's semantic structure.
 *
 * See: docs/rfcs/RFC-029-STARLIGHT-CSS-STRATEGY.md
 */

@layer starlight, overrides;

/* ============================================================================
   FONT DECLARATIONS
   ============================================================================ */

@font-face {
  font-family: "Latin Modern Math";
  src: url("/fonts/LatinModernMath-Regular.otf") format("opentype");
  font-weight: normal;
  font-style: normal;
  font-display: swap;
}

@font-face {
  font-family: "STIX Two Math";
  src: url("/fonts/STIXTwoMath-Regular.ttf") format("truetype");
  font-weight: normal;
  font-style: normal;
  font-display: swap;
}

@font-face {
  font-family: "Libertinus Math";
  src: url("/fonts/LibertinusMath-Regular.otf") format("opentype");
  font-weight: normal;
  font-style: normal;
  font-display: swap;
}

@font-face {
  font-family: "TeX Gyre Pagella Math";
  src: url("/fonts/TexGyrePagellaMath-Regular.otf") format("opentype");
  font-weight: normal;
  font-style: normal;
  font-display: swap;
}

@font-face {
  font-family: "TeX Gyre Termes Math";
  src: url("/fonts/TexGyreTermesMath-Regular.otf") format("opentype");
  font-weight: normal;
  font-style: normal;
  font-display: swap;
}

@font-face {
  font-family: "Fira Math";
  src: url("/fonts/FiraMath-Regular.otf") format("opentype");
  font-weight: normal;
  font-style: normal;
  font-display: swap;
}

@font-face {
  font-family: "Garamond Math";
  src: url("/fonts/Garamond-Math.otf") format("opentype");
  font-weight: normal;
  font-style: normal;
  font-display: swap;
}

@font-face {
  font-family: "Erewhon Math";
  src: url("/fonts/Erewhon-Math.otf") format("opentype");
  font-weight: normal;
  font-style: normal;
  font-display: swap;
}

@font-face {
  font-family: "Asana Math";
  src: url("/fonts/Asana-Math.otf") format("opentype");
  font-weight: normal;
  font-style: normal;
  font-display: swap;
}

@font-face {
  font-family: "XITS Math";
  src: url("/fonts/XITSMath-Regular.otf") format("opentype");
  font-weight: normal;
  font-style: normal;
  font-display: swap;
}

@font-face {
  font-family: "KpMath";
  src: url("/fonts/KpMath-Regular.otf") format("opentype");
  font-weight: normal;
  font-style: normal;
  font-display: swap;
}

@font-face {
  font-family: "Neo Euler";
  src: url("/fonts/NeoEuler.otf") format("opentype");
  font-weight: normal;
  font-style: normal;
  font-display: swap;
}

@layer overrides {
  :root {
    --font-math:
      "Erewhon Math", "Libertinus Math", "STIX Two Math", "Latin Modern Math",
      serif;
  }

  /* Global MathML Styling */

  math {
    font-family: var(--font-math);
    font-size: 1.25em; /* Bump size for better readability */
    line-height: initial; /* Prevent inherited line-height from messing up vertical alignment */
  }

  /* Prevent Starlight's generic content margin from pushing inline math down */
  .sl-markdown-content math:not([display="block"]) {
    margin-top: 0;
  }

  /* Inline code: transparent background with subtle border for distinction.
     Uses only bridge tokens to maintain zero-violation invariant. */
  :root body .sl-markdown-content code:not(:where(.not-content *)) {
    background-color: transparent;
    border: 1px solid var(--axm-bridge-border-dec);
    padding: 0.125rem 0.375rem;
    border-radius: 0.25em;
  }

  math * {
    margin: initial;
  }

  /* Center the wrapper if possible */
  .katex:has(math[display="block"]) {
    display: block;
    text-align: center;
  }

  math[display="block"] {
    display: grid;
    margin-block: 1.5em;
    width: 100%;
    font-size: 1.5em;
    place-items: center;
  }

  /* Mapping the Axiomatic Color System to Starlight's variables */

  /*
   * NOTE: Starlight injects constructed stylesheets late that frequently apply
   * `var(--sl-*)` colors (sometimes `!important`) to Starlight-owned chrome and
   * markdown-rendered elements.
   *
  * We cannot bridge `--sl-*` to Axiomatic *private* internals here.
  * Instead, we map `--sl-*` to the public bridge exports (`--axm-bridge-*`).
   *
   * Instead we neutralize Starlight's color overrides by forcing key elements
   * to inherit text/surface from the Axiomatic system.
   */

  /* Higher specificity prevents Starlight override */
  :root body .sl-anchor-icon {
    color: inherit;
  }

  /* Starlight buttons/cards: higher specificity prevents Starlight override */
  :root body .sl-link-button {
    color: inherit;
    background-color: transparent;
  }

  :root body .card {
    background-color: transparent;
  }

  body {
    --sl-sidebar-width: 18rem;
  }

  .sl-markdown-content p,
  .sl-markdown-content li {
    text-wrap: pretty;
  }

  html {
    overflow-y: scroll;
  }
}

/* Unlayered utilities */
.docs-grid-comparison {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 2rem;
  margin: 2rem 0;
  align-items: start;
}

.docs-grid-comparison > div {
  display: flex;
  flex-direction: column;
  align-items: center;
}

.docs-grid-comparison > div > strong {
  display: block;
  margin-bottom: 1rem;
  font-size: 0.9em;
  color: inherit;
  opacity: 0.75;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

/* Comparison Grid V2 */
.docs-grid-comparison-v2 {
  display: flex;
  flex-direction: column;
  gap: 1rem;
  margin: 2rem 0;
  background: transparent;
  border: 1px solid currentColor;
  border-radius: 0.5rem;
  padding: 1.5rem;
}

.comparison-header {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
  padding-bottom: 0.5rem;
  border-bottom: 1px solid currentColor;
  margin-bottom: 0.5rem;
}

.comparison-header span {
  text-align: center;
  font-size: 0.85rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.comparison-row {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.swatch-pair {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
}

.swatch-col {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.swatch-col .text-xs {
  font-size: 0.8rem;
  color: inherit;
  opacity: 0.75;
  line-height: 1.2;
}

.swatch-pair .docs-swatch {
  width: 100%;
  height: 48px;
  border-radius: 4px;
  border: 1px solid currentColor;
}

.row-header {
  font-size: 0.9rem;
  font-weight: bold;
  color: inherit;
  opacity: 0.75;
  margin-bottom: 0.25rem;
}

.row-label {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 0.9rem;
}

/* --- Starlight Component Tweaks (RFC010-safe) --- */

.sl-link-button.primary {
  background-color: transparent;
  color: inherit;
  border: 1px solid currentColor;
  text-decoration: none;
}

.card {
  background-color: transparent;
  border: 1px solid currentColor;
}

site-search button {
  background-color: transparent;
  border: 1px solid var(--axm-bridge-border-int);
  border-radius: 0.5rem;
  color: inherit;
}

/* Higher specificity prevents Starlight override */
:root body site-search button kbd {
  background-color: transparent;
  border: none;
  box-shadow: none;
  color: inherit;
}

/* Sidebar active state */
a[aria-current="page"] {
  background-color: transparent;
  color: inherit;
}

/* 4. Code Blocks -> Surface Workspace */
/* Higher specificity prevents Starlight/Shiki override */
:root body .astro-code,
:root body .expressive-code .frame {
  background-color: transparent;
  border: 1px solid currentColor;
  border-radius: 0.5rem;
}

:root body .astro-code pre,
:root body .expressive-code pre {
  background-color: transparent;
}

:root body .expressive-code .copy button {
  background-color: transparent;
}

/* 5. Hero Section Safeguard */
.hero {
  /* Ensure the hero is always treated as a dark context if intended, 
     or at least respects the system theme correctly. 
     The issue was "invisible text" in dark mode. */
  position: relative;
  z-index: 1;
  background-color: transparent; /* Let the page surface show through */
}

/* Ensure Hero Actions use our buttons */
.hero .action {
  /* Reset Starlight button styles if needed, but .sl-link-button.primary above might cover it */
}

/* 6. Responsive Tables (Tokens Page) */
.sl-markdown-content table {
  display: block;
  overflow-x: auto;
  white-space: nowrap;
  width: 100%;
}

/* 7. Sidebar Active State -> Surface Action Soft */
/* 8. Headings -> Text High Token - Higher specificity prevents Starlight override */
:root body .sl-markdown-content :is(h1, h2, h3, h4, h5, h6):not(:where(.not-content *)) {
  color: inherit;
}

/* 9. Hero/Large Text -> Text High Token */
.large {
  color: inherit;
}

/* --- Contract-safe neutralization of Starlight palette --- */
/* Goal: eliminate mismatches by letting Axiomatic surfaces/text cascade naturally. */

/*
 * IMPORTANT: do not force `.page` to inherit its background.
 *
 * The docs site applies `surface-*` tokens to Starlight-owned chrome (via
 * runtime DOM wiring). Those tokens must be allowed to paint.
 *
 * A previous approach set `.page { background-color: inherit !important; }`,
 * which can collapse the entire page surface to transparent (blank canvas)
 * depending on what the parent paints.
 */

/* Higher specificity than Starlight's constructed `.header { ... !important }`. */
:root body .page > .header {
  background: none;
  background-color: inherit;
}

:root body .site-title,
:root body .site-title * {
  color: inherit;
}

:root body starlight-theme-select,
:root body starlight-theme-select * {
  color: inherit;
}

/*
 * Theme select must be explicitly styled.
 *
 * Leaving the control transparent causes UA-native option menus to fall back
 * to light palette defaults in some browsers, producing white-on-white in
 * dark mode.
 */
:root body starlight-theme-select select {
  background-color: inherit;
  border: 1px solid var(--axm-bridge-border-int);
}

:root body starlight-theme-select option {
  background-color: inherit;
}

html[data-theme="light"] starlight-theme-select {
  color-scheme: light;
}

html[data-theme="dark"] starlight-theme-select {
  color-scheme: dark;
}

.hero h1,
.hero .tagline {
  color: inherit;
}

/* Starlight page title heading (rendered outside `.sl-markdown-content`). */
:root body .content-panel > .sl-container > h1 {
  color: var(--axm-bridge-fg-high);
}

.hero .tagline {
  opacity: 0.85;
}

.card .title,
.card .title * {
  color: inherit;
}

.meta {
  color: inherit;
  opacity: 0.85;
}

:root body .sl-markdown-content a {
  color: inherit;
}

/* Starlight chrome links (skip link + social icons) */
a[href="#_top"],
.social-icons a {
  color: inherit;
}

/* Optional: Make the description column wrap if we want to avoid scrolling, 
   but scrolling is usually safer for long token names. 
   Let's stick to scrolling for now as per the plan. */

/* --- Unlayered Overrides for Animation --- */
/* We place these outside of @layer to ensure they have high specificity and priority */

:root,
:root[data-theme],
html,
html[data-theme] {
  /* Continuity invariant: `data-theme` must not change system color resolution
    while `--tau` is locked. Starlight may set `color-scheme` per theme; force
    a stable value so `light-dark()` + UA colors don't snap. */
  color-scheme: light dark !important;

  /* --- Starlight Color Neutralization ---
     Starlight's constructed styles can run after user CSS and reassert
     `--sl-color-*` variables. Use `!important` so our Axiomatic mappings win.
  */
  /* Do not force `--tau` transitions from the Starlight adapter.
     The engine gates tau transitions via `data-axm-ready` to avoid boot animate-in. */
}

/* --- Starlight Palette Mapping (Bridge File) ---
   Important: assign foreign palette variables on *near* ancestors (body/page/sidebar)
   so late `:root` reassertions from constructed styles can't win via source order.
   
   RFC-029 + Option B.1: All mappings are pure wiring from bridge exports.
   No color synthesis in the adapter layer.
*/
:root body,
:root .page.sl-flex,
:root .page.sl-flex > .header,
:root #starlight__sidebar.axm-starlight-sidebar-host,
:root #starlight__sidebar.axm-starlight-sidebar-host > .axm-starlight-sidebar {
  /* Map Starlight's palette into Axiomatic bridge exports. */
  --sl-color-text: var(--axm-bridge-fg) !important;
  --sl-color-white: var(--axm-bridge-fg-high) !important;
  --sl-color-black: var(--axm-bridge-surface) !important;

  /* Starlight grays: preserve the 6-step hierarchy with intermediate values. */
  --sl-color-gray-1: var(--axm-bridge-fg-high) !important;
  --sl-color-gray-2: var(--axm-bridge-fg) !important;
  --sl-color-gray-3: var(--axm-bridge-fg-subtle) !important;

  /* Gray-4: Subtlest text level (lightest in the fg stack) */
  --sl-color-gray-4: var(--axm-bridge-fg-subtlest) !important;
  
  /* Gray-5: Decorative border */
  --sl-color-gray-5: var(--axm-bridge-border-dec) !important;
  
  /* Gray-6: Surface (no separate elevation export yet; roadmap B.2) */
  --sl-color-gray-6: var(--axm-bridge-surface) !important;

  /* Hairlines/separators. */
  --sl-color-hairline: var(--axm-bridge-border-dec) !important;
  --sl-color-hairline-light: var(--axm-bridge-border-dec) !important;

  /* --- ACCENT COLORS ---
   * Primary interactive color for links, focus rings, active states.
   * Wired to brand accent bridge exports (Option B.2).
   */
  --sl-color-accent-low: var(--axm-bridge-accent-surface) !important;
  --sl-color-accent: var(--axm-bridge-accent) !important;
  --sl-color-accent-high: var(--axm-bridge-accent-fg) !important;
  --sl-color-text-accent: var(--axm-bridge-accent-fg) !important;
  --sl-color-bg-accent: var(--axm-bridge-accent-surface) !important;

  /* --- SEMANTIC COLORS (for asides/callouts) ---
   * Wired to semantic bridge exports. Engine computes these from
   * theme-defined hues/chromas, ensuring continuity during --tau transitions.
   */

  /* Blue (note/info) */
  --sl-color-blue-low: var(--axm-bridge-info-surface) !important;
  --sl-color-blue: var(--axm-bridge-info) !important;
  --sl-color-blue-high: var(--axm-bridge-info-fg) !important;

  /* Green (tip/success) */
  --sl-color-green-low: var(--axm-bridge-success-surface) !important;
  --sl-color-green: var(--axm-bridge-success) !important;
  --sl-color-green-high: var(--axm-bridge-success-fg) !important;

  /* Orange (caution/warning) */
  --sl-color-orange-low: var(--axm-bridge-warning-surface) !important;
  --sl-color-orange: var(--axm-bridge-warning) !important;
  --sl-color-orange-high: var(--axm-bridge-warning-fg) !important;

  /* Red (danger) */
  --sl-color-red-low: var(--axm-bridge-danger-surface) !important;
  --sl-color-red: var(--axm-bridge-danger) !important;
  --sl-color-red-high: var(--axm-bridge-danger-fg) !important;

  /* Purple: Map to info (closest semantic match in current bridge) */
  --sl-color-purple-low: var(--axm-bridge-info-surface) !important;
  --sl-color-purple: var(--axm-bridge-info) !important;
  --sl-color-purple-high: var(--axm-bridge-info-fg) !important;

  /* Text invert: for text on accent backgrounds (uses bridge export) */
  --sl-color-text-invert: var(--axm-bridge-surface) !important;

  /* --- BACKGROUND VARIATIONS --- */
  --sl-color-bg: var(--axm-bridge-surface) !important;
  
  /* Nav/sidebar: subtle elevation using gray-6 */
  --sl-color-bg-nav: var(--sl-color-gray-6) !important;
  
  /* Inline code: transparent background with border for visual distinction.
     Preserves token vocabulary integrity. */
  --sl-color-bg-inline-code: transparent !important;
}

/* Intentionally no --tau transition forcing here. */

/* --- Starlight Chrome Continuity Contract ---
 *
 * CONTEXT: Load-Order and Constructed Stylesheets
 * ------------------------------------------------
 * Starlight injects constructed stylesheets *after* author CSS loads. These
 * late-injected rules frequently apply `var(--sl-color-*)` with `!important`,
 * which can override our Axiomatic bridge mappings and cause discrete theme
 * snaps during `--tau` transitions.
 *
 * WHY `!important` IS REQUIRED
 * ----------------------------
 * We use `!important` in this section to ensure our routing rules win over
 * Starlight's constructed stylesheet declarations. Without it, Starlight's
 * late `!important` rules would paint discrete backgrounds/colors that bypass
 * the Axiomatic continuity engine.
 *
 * THE "ROUTE, DON'T REMOVE" PRINCIPLE
 * ------------------------------------
 * Instead of using `background: none !important` (which deletes intended
 * styling), we ROUTE colors through Starlight's own variables:
 *   - `var(--sl-color-bg)` → `--axm-bridge-surface` (mapped above)
 *   - `var(--sl-color-bg-nav)` → `--axm-bridge-surface` (nav surfaces)
 *   - `var(--sl-color-text)` → `--axm-bridge-fg` (foreground text)
 *
 * This preserves Starlight's semantic intent while routing all color
 * resolution through the Axiomatic bridge, ensuring continuity-safe behavior.
 *
 * INTENTIONAL TRANSPARENCY
 * ------------------------
 * Some elements are set to `transparent` intentionally when a child wrapper
 * is responsible for painting the surface. These cases are clearly commented.
 *
 * NOTE ON !important IN ROUTING RULES
 * ------------------------------------
 * The routing rules below use higher specificity (`:root body`, `:root .page`)
 * instead of `!important` wherever possible. The variable mappings above use
 * `!important` (lock pattern), but rules that *consume* those variables can
 * often rely on specificity alone.
 */

:root body {
  /* Route through Starlight's background variable (already mapped to --axm-bridge-surface) */
  background-color: var(--sl-color-bg);
}

:root body .page.sl-flex.axm-starlight-page {
  /* Use Starlight vars (already mapped to bridge) for consistency */
  background-color: var(--sl-color-bg);
  color: var(--sl-color-text);
}

/* Header: consolidated rule using selector grouping */
:root body .page.sl-flex > .header,
:root body header.axm-starlight-header {
  /* Route through Starlight's nav background (already mapped to --axm-bridge-surface) */
  background-color: var(--sl-color-bg-nav);
  color: var(--sl-color-text);
  border-bottom: 1px solid var(--axm-bridge-border-int);
}

/* Sidebar: the host stays transparent; the inner wrapper paints `surface-workspace`. */
:root body #starlight__sidebar.axm-starlight-sidebar-host {
  /* Intentionally transparent: .axm-starlight-sidebar wrapper paints surface-workspace */
  background-color: transparent;
  border-right-color: var(--axm-bridge-border-dec);
}

/* Sidebar section tree guides: bridge-route the left borders explicitly. */
:root body #starlight__sidebar ul ul li {
  border-inline-start: 1px solid var(--axm-bridge-border-dec);
}

:root body #starlight__sidebar.axm-starlight-sidebar-host > .axm-starlight-sidebar {
  min-height: 100%;
}

/* Starlight chrome regions that commonly use --sl-color-* directly. */
:root body .dialog-frame {
  color: var(--sl-color-text);
}

:root body .display-current,
:root body .link-title {
  color: var(--sl-color-text);
}

/* Search: ensure the Pagefind input doesn't paint a discrete high-contrast
   color that diverges from the Axiomatic text pipeline. */
:root body #starlight__search .pagefind-ui__search-input {
  color: var(--sl-color-text);
}

/* Expressive Code: the filename/title chip must not paint a discrete mode background.
   It should inherit/compose with the surrounding surface instead. */
:root body .expressive-code .frame.has-title > .header > .title {
  /* Transparent: compose with code block surface, avoid theme snap */
  background-color: transparent;
}

/* Expressive Code: copy button chrome must not snap on theme toggles while `--tau` is locked. */
:root body .expressive-code button,
:root body .expressive-code button > * {
  /* Transparent: compose with code block surface chrome */
  background-color: transparent;
}

/* Landing page "Why This Matters" icons: treat as transparent chrome (no theme-dependent background). */
:root body .sl-markdown-content article svg.icon {
  /* Transparent: icons compose with their container surface */
  background-color: transparent;
}
