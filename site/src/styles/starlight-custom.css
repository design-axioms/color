@layer starlight, overrides;

/* Starlight Overrides */

@font-face {
  font-family: "Latin Modern Math";
  src: url("/fonts/LatinModernMath-Regular.otf") format("opentype");
  font-weight: normal;
  font-style: normal;
  font-display: swap;
}

@font-face {
  font-family: "STIX Two Math";
  src: url("/fonts/STIXTwoMath-Regular.ttf") format("truetype");
  font-weight: normal;
  font-style: normal;
  font-display: swap;
}

@font-face {
  font-family: "Libertinus Math";
  src: url("/fonts/LibertinusMath-Regular.otf") format("opentype");
  font-weight: normal;
  font-style: normal;
  font-display: swap;
}

@font-face {
  font-family: "TeX Gyre Pagella Math";
  src: url("/fonts/TexGyrePagellaMath-Regular.otf") format("opentype");
  font-weight: normal;
  font-style: normal;
  font-display: swap;
}

@font-face {
  font-family: "TeX Gyre Termes Math";
  src: url("/fonts/TexGyreTermesMath-Regular.otf") format("opentype");
  font-weight: normal;
  font-style: normal;
  font-display: swap;
}

@font-face {
  font-family: "Fira Math";
  src: url("/fonts/FiraMath-Regular.otf") format("opentype");
  font-weight: normal;
  font-style: normal;
  font-display: swap;
}

@font-face {
  font-family: "Garamond Math";
  src: url("/fonts/Garamond-Math.otf") format("opentype");
  font-weight: normal;
  font-style: normal;
  font-display: swap;
}

@font-face {
  font-family: "Erewhon Math";
  src: url("/fonts/Erewhon-Math.otf") format("opentype");
  font-weight: normal;
  font-style: normal;
  font-display: swap;
}

@font-face {
  font-family: "Asana Math";
  src: url("/fonts/Asana-Math.otf") format("opentype");
  font-weight: normal;
  font-style: normal;
  font-display: swap;
}

@font-face {
  font-family: "XITS Math";
  src: url("/fonts/XITSMath-Regular.otf") format("opentype");
  font-weight: normal;
  font-style: normal;
  font-display: swap;
}

@font-face {
  font-family: "KpMath";
  src: url("/fonts/KpMath-Regular.otf") format("opentype");
  font-weight: normal;
  font-style: normal;
  font-display: swap;
}

@font-face {
  font-family: "Neo Euler";
  src: url("/fonts/NeoEuler.otf") format("opentype");
  font-weight: normal;
  font-style: normal;
  font-display: swap;
}

@layer overrides {
  :root {
    --font-math:
      "Erewhon Math", "Libertinus Math", "STIX Two Math", "Latin Modern Math",
      serif;
  }

  /* Global MathML Styling */

  math {
    font-family: var(--font-math);
    font-size: 1.25em; /* Bump size for better readability */
    line-height: initial; /* Prevent inherited line-height from messing up vertical alignment */
  }

  /* Prevent Starlight's generic content margin from pushing inline math down */
  .sl-markdown-content math:not([display="block"]) {
    margin-top: 0;
  }

  .sl-markdown-content code:not(:where(.not-content *)) {
    background-color: transparent !important;
    border: 1px solid currentColor;
    padding: 0.1em 0.3em;
    border-radius: 0.25em;
  }

  math * {
    margin: initial;
  }

  /* Center the wrapper if possible */
  .katex:has(math[display="block"]) {
    display: block;
    text-align: center;
  }

  math[display="block"] {
    display: grid;
    margin-block: 1.5em;
    width: 100%;
    font-size: 1.5em;
    place-items: center;
  }

  /* Mapping the Axiomatic Color System to Starlight's variables */

  /*
   * NOTE: Starlight injects constructed stylesheets late that frequently apply
   * `var(--sl-*)` colors (sometimes `!important`) to Starlight-owned chrome and
   * markdown-rendered elements.
   *
  * We cannot bridge `--sl-*` to Axiomatic *private* internals here.
  * Instead, we map `--sl-*` to the public bridge exports (`--axm-bridge-*`).
   *
   * Instead we neutralize Starlight's color overrides by forcing key elements
   * to inherit text/surface from the Axiomatic system.
   */

  .sl-anchor-icon {
    color: inherit !important;
  }

  /* Starlight buttons/cards: avoid Starlight-owned surfaces/colors. */
  .sl-link-button {
    color: inherit !important;
    background-color: transparent !important;
  }

  .card {
    background-color: transparent !important;
  }

  body {
    --sl-sidebar-width: 18rem;
  }

  .sl-markdown-content p,
  .sl-markdown-content li {
    text-wrap: pretty;
  }

  html {
    overflow-y: scroll;
  }
}

/* Unlayered utilities */
.docs-grid-comparison {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 2rem;
  margin: 2rem 0;
  align-items: start;
}

.docs-grid-comparison > div {
  display: flex;
  flex-direction: column;
  align-items: center;
}

.docs-grid-comparison > div > strong {
  display: block;
  margin-bottom: 1rem;
  font-size: 0.9em;
  color: inherit;
  opacity: 0.75;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

/* Comparison Grid V2 */
.docs-grid-comparison-v2 {
  display: flex;
  flex-direction: column;
  gap: 1rem;
  margin: 2rem 0;
  background: transparent;
  border: 1px solid currentColor;
  border-radius: 0.5rem;
  padding: 1.5rem;
}

.comparison-header {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
  padding-bottom: 0.5rem;
  border-bottom: 1px solid currentColor;
  margin-bottom: 0.5rem;
}

.comparison-header span {
  text-align: center;
  font-size: 0.85rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.comparison-row {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.swatch-pair {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
}

.swatch-col {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.swatch-col .text-xs {
  font-size: 0.8rem;
  color: inherit;
  opacity: 0.75;
  line-height: 1.2;
}

.swatch-pair .docs-swatch {
  width: 100%;
  height: 48px;
  border-radius: 4px;
  border: 1px solid currentColor;
}

.row-header {
  font-size: 0.9rem;
  font-weight: bold;
  color: inherit;
  opacity: 0.75;
  margin-bottom: 0.25rem;
}

.row-label {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 0.9rem;
}

/* --- Starlight Component Tweaks (RFC010-safe) --- */

.sl-link-button.primary {
  background-color: transparent;
  color: inherit;
  border: 1px solid currentColor;
  text-decoration: none;
}

.card {
  background-color: transparent;
  border: 1px solid currentColor;
}

site-search button {
  background-color: transparent;
  border: 1px solid var(--axm-bridge-border-int);
  border-radius: 0.5rem;
  color: inherit;
}

site-search button kbd {
  background-color: transparent !important;
  border: none;
  box-shadow: none;
  color: inherit;
}

/* Sidebar active state */
a[aria-current="page"] {
  background-color: transparent;
  color: inherit;
}

/* 4. Code Blocks -> Surface Workspace */
.astro-code,
.expressive-code .frame {
  /* Force override of Shiki's inline styles */
  background-color: transparent !important;
  border: 1px solid currentColor;
  border-radius: 0.5rem;
}

.astro-code pre,
.expressive-code pre {
  background-color: transparent !important;
}

.expressive-code .copy button {
  background-color: transparent !important;
  /* If it has a border or other styles, keep them, but background should match surface */
}

/* 5. Hero Section Safeguard */
.hero {
  /* Ensure the hero is always treated as a dark context if intended, 
     or at least respects the system theme correctly. 
     The issue was "invisible text" in dark mode. */
  position: relative;
  z-index: 1;
  background-color: transparent; /* Let the page surface show through */
}

/* Ensure Hero Actions use our buttons */
.hero .action {
  /* Reset Starlight button styles if needed, but .sl-link-button.primary above might cover it */
}

/* 6. Responsive Tables (Tokens Page) */
.sl-markdown-content table {
  display: block;
  overflow-x: auto;
  white-space: nowrap;
  width: 100%;
}

/* 7. Sidebar Active State -> Surface Action Soft */
/* 8. Headings -> Text High Token */
.sl-markdown-content :is(h1, h2, h3, h4, h5, h6):not(:where(.not-content *)) {
  color: inherit !important;
}

/* 9. Hero/Large Text -> Text High Token */
.large {
  color: inherit;
}

/* --- Contract-safe neutralization of Starlight palette --- */
/* Goal: eliminate mismatches by letting Axiomatic surfaces/text cascade naturally. */

/*
 * IMPORTANT: do not force `.page` to inherit its background.
 *
 * The docs site applies `surface-*` tokens to Starlight-owned chrome (via
 * runtime DOM wiring). Those tokens must be allowed to paint.
 *
 * A previous approach set `.page { background-color: inherit !important; }`,
 * which can collapse the entire page surface to transparent (blank canvas)
 * depending on what the parent paints.
 */

/* Higher specificity than Starlight's constructed `.header { ... !important }`. */
.page > .header {
  background: none !important;
  background-color: inherit !important;
}

.site-title,
.site-title * {
  color: inherit !important;
}

starlight-theme-select,
starlight-theme-select * {
  color: inherit !important;
}

/*
 * Theme select must be explicitly styled.
 *
 * Leaving the control transparent causes UA-native option menus to fall back
 * to light palette defaults in some browsers, producing white-on-white in
 * dark mode.
 */
starlight-theme-select select {
  background-color: inherit !important;
  border: 1px solid var(--axm-bridge-border-int) !important;
}

starlight-theme-select option {
  background-color: inherit !important;
}

html[data-theme="light"] starlight-theme-select {
  color-scheme: light;
}

html[data-theme="dark"] starlight-theme-select {
  color-scheme: dark;
}

.hero h1,
.hero .tagline {
  color: inherit;
}

/* Starlight page title heading (rendered outside `.sl-markdown-content`). */
.content-panel > .sl-container > h1 {
  color: var(--axm-bridge-fg-high) !important;
}

.hero .tagline {
  opacity: 0.85;
}

.card .title,
.card .title * {
  color: inherit;
}

.meta {
  color: inherit;
  opacity: 0.85;
}

.sl-markdown-content a {
  color: inherit !important;
}

/* Starlight chrome links (skip link + social icons) */
a[href="#_top"],
.social-icons a {
  color: inherit;
}

/* Optional: Make the description column wrap if we want to avoid scrolling, 
   but scrolling is usually safer for long token names. 
   Let's stick to scrolling for now as per the plan. */

/* --- Unlayered Overrides for Animation --- */
/* We place these outside of @layer to ensure they have high specificity and priority */

:root,
:root[data-theme],
html,
html[data-theme] {
  /* Continuity invariant: `data-theme` must not change system color resolution
    while `--tau` is locked. Starlight may set `color-scheme` per theme; force
    a stable value so `light-dark()` + UA colors don't snap. */
  color-scheme: light dark !important;

  /* --- Starlight Color Neutralization ---
     Starlight's constructed styles can run after user CSS and reassert
     `--sl-color-*` variables. Use `!important` so our Axiomatic mappings win.
  */
  /* Do not force `--tau` transitions from the Starlight adapter.
     The engine gates tau transitions via `data-axm-ready` to avoid boot animate-in. */
}

/* --- Starlight Palette Mapping (Bridge File) ---
   Important: assign foreign palette variables on *near* ancestors (body/page/sidebar)
   so late `:root` reassertions from constructed styles can't win via source order.
*/
:root body,
:root .page.sl-flex,
:root .page.sl-flex > .header,
:root #starlight__sidebar.axm-starlight-sidebar-host,
:root #starlight__sidebar.axm-starlight-sidebar-host > .axm-starlight-sidebar {
  /* Map Starlight's palette into Axiomatic bridge exports.
      Avoid using the CSS keyword `inherit` here: if Starlight uses
      `background-color: var(--sl-color-white)`, `inherit` can cause chrome to
      inherit the *body* background, bypassing per-surface computation.
    */
  --sl-color-text: var(--axm-bridge-fg) !important;
  /*
   * Starlight semantics:
   * - `--sl-color-white` is the high-contrast “ink” endpoint.
   * - `--sl-color-black` is the “paper/surface” endpoint.
   */
  --sl-color-white: var(--axm-bridge-fg-high) !important;
  --sl-color-black: var(--axm-bridge-surface) !important;

  /* Starlight grays: align to semantics (gray-2 is core text). */
  --sl-color-gray-1: var(--axm-bridge-fg-high) !important;
  --sl-color-gray-2: var(--axm-bridge-fg) !important;
  --sl-color-gray-3: var(--axm-bridge-fg-subtle) !important;

  /* Chrome borders/dividers. */
  --sl-color-gray-4: var(--axm-bridge-border-int) !important;
  --sl-color-gray-5: var(--axm-bridge-border-dec) !important;

  /* Hairlines/separators. */
  --sl-color-gray-6: var(--axm-bridge-surface) !important;
  --sl-color-hairline: var(--axm-bridge-border-dec) !important;
  /* Starlight uses this alias for certain chrome hairlines (e.g. sidebar tree guides). */
  --sl-color-hairline-light: var(--axm-bridge-border-dec) !important;

  /* Role colors: map to bridge exports so they inherit per surface/hue context. */
  --sl-color-text-accent: var(--axm-bridge-fg) !important;
  --sl-color-text-invert: var(--axm-bridge-fg) !important;
  --sl-color-bg-accent: var(--axm-bridge-surface) !important;

  /* Backgrounds. */
  --sl-color-bg: var(--axm-bridge-surface) !important;
  --sl-color-bg-nav: var(--axm-bridge-surface) !important;
}

/* Intentionally no `--tau` transition forcing here. */

/* --- Starlight Chrome Continuity Contract ---
   Starlight may apply mode-dependent backgrounds and/or temporarily disable
   transitions via late constructed stylesheets. For Axiomatic continuity, the
   chrome must not paint its own discrete background; it must either inherit
   the page surface or paint via Axiomatic surface classes.

   These rules are intentionally UNLAYERED and high-specificity so they can
   outrank Starlight's constructed rules.
*/

:root body {
  background: none !important;
}

:root .page.sl-flex.axm-starlight-page {
  background: var(--axm-bridge-surface) !important;
  background-color: var(--axm-bridge-surface) !important;
  color: var(--axm-bridge-fg) !important;
}

:root .page.sl-flex > .header {
  background: none !important;
  color: var(--axm-bridge-fg) !important;
  border-bottom: 1px solid var(--axm-bridge-border-int) !important;
}

:root .page.sl-flex > .header.axm-starlight-header.axm-starlight-header {
  background: none !important;
  color: var(--axm-bridge-fg) !important;
  border-bottom: 1px solid var(--axm-bridge-border-int) !important;
}

:root header.axm-starlight-header.axm-starlight-header {
  background: none !important;
  color: var(--axm-bridge-fg) !important;
  border-bottom: 1px solid var(--axm-bridge-border-int) !important;
}

/* Sidebar: the host stays transparent; the inner wrapper paints `surface-workspace`. */
:root #starlight__sidebar.axm-starlight-sidebar-host {
  background: none !important;
  border-right-color: var(--axm-bridge-border-dec) !important;
}

/* Sidebar section tree guides: bridge-route the left borders explicitly.
   Starlight applies these via component-scoped selectors, so we override the
   shorthand with `!important` at the sidebar root. */
:root #starlight__sidebar ul ul li {
  border-inline-start: 1px solid var(--axm-bridge-border-dec) !important;
}

:root #starlight__sidebar.axm-starlight-sidebar-host > .axm-starlight-sidebar {
  min-height: 100%;
}

/* Starlight chrome regions that commonly use --sl-color-* directly.
   Force paint through public bridge exports (adapter contract). */
:root .dialog-frame {
  color: var(--sl-color-text) !important;
}

:root .display-current,
:root .link-title {
  color: var(--sl-color-text) !important;
}

/* Search: ensure the Pagefind input doesn't paint a discrete high-contrast
   color that diverges from the Axiomatic text pipeline. */
:root #starlight__search .pagefind-ui__search-input {
  color: var(--sl-color-text) !important;
}

/* Expressive Code: the filename/title chip must not paint a discrete mode background.
   It should inherit/compose with the surrounding surface instead. */
:root .expressive-code .frame.has-title > .header > .title {
  background: none !important;
}

/* Expressive Code: copy button chrome must not snap on theme toggles while `--tau` is locked. */
:root .expressive-code button,
:root .expressive-code button > * {
  background: none !important;
}

/* Landing page "Why This Matters" icons: treat as transparent chrome (no theme-dependent background). */
:root .sl-markdown-content article svg.icon {
  background: none !important;
}
