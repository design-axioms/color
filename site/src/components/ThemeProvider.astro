---
// Custom ThemeProvider override for Starlight.
//
// This component provides the StarlightThemeProvider global (required for updatePickers())
// but does NOT write data-theme directly. Instead, it reads localStorage and sets 
// data-axm-mode and data-axm-resolved-mode. AxiomaticTheme.set() will write data-theme later.
//
// This prevents "split-brain" dark mode where Starlight's ThemeProvider and our code
// both try to manage theme state independently.
---

{/* Icon template for updatePickers to swap icons. Uses inline SVGs matching Starlight's icon set. */}
<template id="theme-icons">
	{/* Sun icon for light mode */}
	<svg class="light" aria-hidden="true" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
		<path d="M12 18a6 6 0 1 1 0-12 6 6 0 0 1 0 12Zm0-2a4 4 0 1 0 0-8 4 4 0 0 0 0 8ZM11 1h2v3h-2V1Zm0 19h2v3h-2v-3ZM3.515 4.929l1.414-1.414L7.05 5.636 5.636 7.05 3.515 4.93ZM16.95 18.364l1.414-1.414 2.121 2.121-1.414 1.414-2.121-2.121Zm2.121-14.85 1.414 1.415-2.121 2.121-1.414-1.414 2.121-2.121ZM5.636 16.95l1.414 1.414-2.121 2.121-1.414-1.414 2.121-2.121ZM23 11v2h-3v-2h3ZM4 11v2H1v-2h3Z"/>
	</svg>
	{/* Moon icon for dark mode */}
	<svg class="dark" aria-hidden="true" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
		<path d="M10 7a7 7 0 0 0 12 4.9v.1c0 5.523-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2h.1A6.979 6.979 0 0 0 10 7Zm-6 5a8 8 0 0 0 15.062 3.762A9 9 0 0 1 8.238 4.938 7.999 7.999 0 0 0 4 12Z"/>
	</svg>
	{/* Laptop icon for auto/system mode */}
	<svg class="auto" aria-hidden="true" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
		<path d="M4 5v11h16V5H4Zm-2-.993C2 3.451 2.455 3 2.992 3h18.016c.548 0 .992.449.992 1.007V18H2V4.007ZM1 19h22v2H1v-2Z"/>
	</svg>
</template>

<script is:inline>
	window.StarlightThemeProvider = (() => {
		/** Storage key for theme preference (Starlight standard) */
		const storageKey = "starlight-theme";

		/** Parse Starlight's localStorage format: "" = auto, "light" | "dark" = explicit */
		const parseStarlightTheme = (raw) => {
			if (!raw) return "system";
			return raw === "light" || raw === "dark" ? raw : "system";
		};

		/** Get the current theme from localStorage */
		const loadTheme = () => {
			if (typeof localStorage === "undefined") return "system";
			try {
				const raw = localStorage.getItem(storageKey);
				return parseStarlightTheme(raw);
			} catch {
				return "system";
			}
		};

		/** Get the system preference */
		const getSystemResolved = () => {
			if (typeof matchMedia === "undefined") return "light";
			return matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
		};

		/** Resolve mode to actual appearance */
		const resolveMode = (mode) => {
			return mode === "system" ? getSystemResolved() : mode;
		};

		// Bootstrap initial theme state from localStorage
		const mode = loadTheme();
		const resolved = resolveMode(mode);

		// Set Axiomatic semantic attributes AND data-theme for immediate first-paint sync.
		// Starlight's SSR bakes data-theme="dark" into HTML, so we must override it here
		// to prevent FOUC. ThemeManager will take over after initialization.
		document.documentElement.setAttribute("data-axm-mode", mode);
		document.documentElement.setAttribute("data-axm-resolved-mode", resolved);
		document.documentElement.setAttribute("data-theme", resolved);

		/** Update all theme select UI components to show the current theme */
		const updatePickers = (theme = loadTheme()) => {
			// Convert internal "system" to Starlight's "auto"
			const starlightTheme = theme === "system" ? "auto" : theme;
			
			document.querySelectorAll("starlight-theme-select").forEach((picker) => {
				const select = picker.querySelector("select");
				if (select) select.value = starlightTheme;
				
				/** @type {HTMLTemplateElement | null} */
				const tmpl = document.querySelector("#theme-icons");
				const newIcon = tmpl && tmpl.content.querySelector("." + starlightTheme);
				if (newIcon) {
					const oldIcon = picker.querySelector("svg.label-icon");
					if (oldIcon) {
						oldIcon.replaceChildren(...newIcon.cloneNode(true).childNodes);
					}
				}
			});
		};

		// Provide global API for ThemeSelect components
		return { updatePickers };
	})();
</script>
