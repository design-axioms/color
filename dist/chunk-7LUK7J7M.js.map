{"version":3,"sources":["../src/lib/math.ts"],"names":[],"mappings":";;;;AAIA,IAAM,KAAA,GAAQ,UAAU,KAAK,CAAA;AAGtB,SAAS,aAAa,SAAA,EAA6C;AACxE,EAAA,MAAM,GAAA,GAAM,KAAA,CAAM,EAAE,IAAA,EAAM,OAAA,EAAS,CAAA,EAAG,OAAA,CAAQ,SAAS,CAAA,EAAG,CAAA,EAAG,CAAA,EAAG,CAAA,EAAG,GAAG,CAAA;AAEtE,EAAA,MAAM,YAAA,GAAe,CAAC,KAAA,KAA0B;AAC9C,IAAA,MAAM,OAAA,GAAU,QAAQ,KAAK,CAAA;AAC7B,IAAA,OAAO,IAAA,CAAK,KAAA,CAAM,OAAA,GAAU,GAAG,CAAA;AAAA,EACjC,CAAA;AAEA,EAAA,OAAO,CAAC,YAAA,CAAa,GAAA,CAAI,CAAC,CAAA,EAAG,YAAA,CAAa,GAAA,CAAI,CAAC,CAAA,EAAG,YAAA,CAAa,GAAA,CAAI,CAAC,CAAC,CAAA;AACvE;AAGO,SAAS,eAAA,CACd,YACA,UAAA,EACQ;AACR,EAAA,MAAM,GAAA,GAAM,OAAA,CAAQ,YAAA,CAAa,UAAU,CAAC,CAAA;AAC5C,EAAA,MAAM,GAAA,GAAM,OAAA,CAAQ,YAAA,CAAa,UAAU,CAAC,CAAA;AAC5C,EAAA,MAAM,QAAA,GAAW,YAAA,CAAa,GAAA,EAAK,GAAG,CAAA;AACtC,EAAA,MAAM,UAAU,OAAO,QAAA,KAAa,QAAA,GAAW,QAAA,GAAW,OAAO,QAAQ,CAAA;AAEzE,EAAA,IAAI,CAAC,MAAA,CAAO,QAAA,CAAS,OAAO,CAAA,EAAG;AAC7B,IAAA,MAAM,IAAI,KAAA;AAAA,MACR,CAAA,wDAAA,EAA2D,UAAU,CAAA,gBAAA,EAAmB,UAAU,CAAA,CAAA;AAAA,KACpG;AAAA,EACF;AAEA,EAAA,OAAO,IAAA,CAAK,IAAI,OAAO,CAAA;AACzB;AAIO,IAAM,gBAAA,GAAmB;AACzB,IAAM,mBAAA,GAAsB;AAEnC,IAAM,aAAA,GAAgB,GAAA;AACtB,IAAM,eAAA,GAAkB,GAAA;AACxB,IAAM,iBAAA,GAAoB,EAAA;AAC1B,IAAM,IAAA,GAAA,CAAQ,kBAAkB,iBAAA,IAAqB,CAAA;AAI9C,SAAS,QAAQ,KAAA,EAAuB;AAC7C,EAAA,OAAO,OAAA,CAAQ,KAAA,EAAO,CAAA,EAAG,CAAC,CAAA;AAC5B;AAEO,SAAS,OAAA,CAAQ,KAAA,EAAe,GAAA,EAAa,GAAA,EAAqB;AACvE,EAAA,IAAI,KAAA,GAAQ,KAAK,OAAO,GAAA;AACxB,EAAA,IAAI,KAAA,GAAQ,KAAK,OAAO,GAAA;AACxB,EAAA,OAAO,KAAA;AACT;AAEO,SAAS,eAAe,KAAA,EAAuB;AACpD,EAAA,OAAO,MAAA,CAAO,KAAA,CAAM,OAAA,CAAQ,mBAAmB,CAAC,CAAA;AAClD;AAEO,SAAS,eAAA,CAAgB,KAAA,EAAe,MAAA,GAAS,CAAA,EAAW;AACjE,EAAA,OAAO,MAAA,CAAO,KAAA,CAAM,OAAA,CAAQ,MAAM,CAAC,CAAA;AACrC;AAEO,IAAM,GAAA,GAAM,CAAC,OAAA,KAA8B;AAChD,EAAA,MAAM,KAAA,GAAQ,QAAQ,MAAA,CAAO,CAAC,KAAK,CAAA,KAAM,GAAA,GAAM,GAAG,CAAC,CAAA;AACnD,EAAA,OAAO,QAAQ,OAAA,CAAQ,MAAA;AACzB;AAIO,SAAS,YAAA,CACd,KACA,GAAA,EACA,QAAA,EACA,QACA,OAAA,GAAkB,IAAA,EAClB,gBAAwB,EAAA,EAChB;AACR,EAAA,IAAI,GAAA,GAAM,GAAA;AACV,EAAA,IAAI,IAAA,GAAO,GAAA;AAEX,EAAA,MAAM,QAAA,GAAW,SAAS,GAAG,CAAA;AAC7B,EAAA,MAAM,QAAA,GAAW,SAAS,GAAG,CAAA;AAC7B,EAAA,MAAM,KAAA,GAAQ,IAAA,CAAK,IAAA,CAAK,QAAA,GAAW,QAAQ,CAAA,IAAK,CAAA;AAEhD,EAAA,MAAM,MAAA,GAAS,IAAA,CAAK,GAAA,CAAI,QAAA,EAAU,QAAQ,CAAA;AAC1C,EAAA,MAAM,MAAA,GAAS,IAAA,CAAK,GAAA,CAAI,QAAA,EAAU,QAAQ,CAAA;AAE1C,EAAA,IAAI,UAAU,MAAA,GAAS,OAAA,EAAS,OAAO,QAAA,IAAY,WAAW,GAAA,GAAM,GAAA;AACpE,EAAA,IAAI,UAAU,MAAA,GAAS,OAAA,EAAS,OAAO,QAAA,IAAY,WAAW,GAAA,GAAM,GAAA;AAEpE,EAAA,KAAA,IAAS,CAAA,GAAI,CAAA,EAAG,CAAA,GAAI,aAAA,EAAe,CAAA,EAAA,EAAK;AACtC,IAAA,MAAM,GAAA,GAAA,CAAO,MAAM,IAAA,IAAQ,CAAA;AAC3B,IAAA,MAAM,GAAA,GAAM,SAAS,GAAG,CAAA;AACxB,IAAA,MAAM,QAAQ,GAAA,GAAM,MAAA;AAEpB,IAAA,IAAI,IAAA,CAAK,GAAA,CAAI,KAAK,CAAA,IAAK,OAAA,EAAS;AAC9B,MAAA,OAAO,GAAA;AAAA,IACT;AAEA,IAAA,IAAI,KAAA,GAAQ,QAAQ,CAAA,EAAG;AACrB,MAAA,IAAA,GAAO,GAAA;AAAA,IACT,CAAA,MAAO;AACL,MAAA,GAAA,GAAM,GAAA;AAAA,IACR;AAAA,EACF;AAEA,EAAA,OAAA,CAAQ,MAAM,IAAA,IAAQ,CAAA;AACxB;AAIO,SAAS,cAAc,OAAA,EAA0B;AACtD,EAAA,MAAM,EAAE,QAAA,EAAU,IAAA,EAAK,GAAI,OAAA;AAC3B,EAAA,IAAI,aAAa,MAAA,EAAQ;AACvB,IAAA,OAAO,IAAA,KAAS,UAAU,CAAA,GAAI,CAAA;AAAA,EAChC;AACA,EAAA,OAAO,IAAA,KAAS,UAAU,CAAA,GAAI,CAAA;AAChC;AAEO,SAAS,qBAAA,CACd,SACA,UAAA,EACQ;AACR,EAAA,OAAO,eAAA,CAAgB,aAAA,CAAc,OAAO,CAAA,EAAG,UAAU,CAAA;AAC3D;AAEO,SAAS,gBAAA,CAAiB,OAAe,GAAA,EAA+B;AAC7E,EAAA,OAAO,CAAC,IAAA,CAAK,GAAA,CAAI,KAAA,EAAO,GAAG,GAAG,IAAA,CAAK,GAAA,CAAI,KAAA,EAAO,GAAG,CAAC,CAAA;AACpD;AAEO,SAAS,aAAA,CAAc,SAAkB,MAAA,EAAwB;AACtE,EAAA,MAAM,cAAA,GAAiB,qBAAA,CAAsB,OAAA,EAAS,CAAC,CAAA;AACvD,EAAA,MAAM,aAAA,GAAgB,qBAAA,CAAsB,OAAA,EAAS,CAAC,CAAA;AACtD,EAAA,MAAM,GAAA,GAAM,IAAA,CAAK,GAAA,CAAI,cAAA,EAAgB,aAAa,CAAA;AAClD,EAAA,MAAM,GAAA,GAAM,IAAA,CAAK,GAAA,CAAI,cAAA,EAAgB,aAAa,CAAA;AAClD,EAAA,IAAI,MAAA,GAAS,KAAK,OAAO,GAAA;AACzB,EAAA,IAAI,MAAA,GAAS,KAAK,OAAO,GAAA;AACzB,EAAA,OAAO,MAAA;AACT;AAEO,SAAS,0BAAA,CACd,OAAA,EACA,cAAA,EACA,UAAA,EACA,UAAA,EACQ;AACR,EAAA,MAAM,CAAC,KAAA,EAAO,KAAK,CAAA,GAAI,gBAAA,CAAiB,YAAY,UAAU,CAAA;AAC9D,EAAA,MAAM,aAAA,GAAgB,aAAA,CAAc,OAAA,EAAS,cAAc,CAAA;AAE3D,EAAA,MAAM,MAAA,GAAS,YAAA;AAAA,IACb,KAAA;AAAA,IACA,KAAA;AAAA,IACA,CAAC,EAAA,KAAO,qBAAA,CAAsB,OAAA,EAAS,EAAE,CAAA;AAAA,IACzC,aAAA;AAAA,IACA;AAAA,GACF;AAEA,EAAA,OAAO,eAAe,MAAM,CAAA;AAC9B;AAEO,SAAS,wBAAA,CACd,YACA,cAAA,EACQ;AACR,EAAA,MAAM,eAAA,GAAkB,eAAA,CAAgB,CAAA,EAAG,UAAU,CAAA;AACrD,EAAA,MAAM,cAAA,GAAiB,eAAA,CAAgB,CAAA,EAAG,UAAU,CAAA;AACpD,EAAA,MAAM,gBAAgB,eAAA,IAAmB,cAAA;AAEzC,EAAA,MAAM,KAAA,GAA0B,gBAC5B,CAAC,UAAA,EAAY,CAAC,CAAA,GACd,CAAC,GAAG,UAAU,CAAA;AAElB,EAAA,MAAM,MAAA,GAAS,YAAA;AAAA,IACb,MAAM,CAAC,CAAA;AAAA,IACP,MAAM,CAAC,CAAA;AAAA,IACP,CAAC,EAAA,KAAO,eAAA,CAAgB,EAAA,EAAI,UAAU,CAAA;AAAA,IACtC,cAAA;AAAA,IACA;AAAA,GACF;AAEA,EAAA,OAAO,eAAA,CAAgB,OAAA,CAAQ,MAAM,CAAC,CAAA;AACxC;AAEO,SAAS,gBAAA,CACd,QAAA,EACA,KAAA,EACA,cAAA,EACQ;AACR,EAAA,OAAO,YAAA;AAAA,IACL,CAAA;AAAA,IACA,CAAA;AAAA,IACA,CAAC,KAAA,KAAU;AACT,MAAA,MAAM,OAAA,GAAU,KAAA,GAAQ,KAAA,GAAQ,QAAA,IAAY,CAAA,GAAI,KAAA,CAAA;AAChD,MAAA,OAAO,eAAA,CAAgB,SAAS,QAAQ,CAAA;AAAA,IAC1C,CAAA;AAAA,IACA,cAAA;AAAA,IACA;AAAA,GACF;AACF;AAIA,SAAS,WAAA,CAAY,CAAA,EAAW,EAAA,EAAY,EAAA,EAAoB;AAC9D,EAAA,MAAM,YAAY,CAAA,GAAI,CAAA;AACtB,EAAA,OACE,CAAA,GAAI,SAAA,GAAY,SAAA,GAAY,CAAA,GAAI,EAAA,GAAK,CAAA,GAAI,SAAA,GAAY,CAAA,GAAI,CAAA,GAAI,EAAA,GAAK,CAAA,GAAI,CAAA,GAAI,CAAA;AAE9E;AAEO,SAAS,iBAAA,CACd,WACA,MAAA,EAIQ;AACR,EAAA,IAAI,CAAC,QAAQ,OAAO,CAAA;AACpB,EAAA,MAAM,EAAE,KAAA,EAAO,WAAA,EAAY,GAAI,MAAA;AAC/B,EAAA,MAAM,MAAA,GAAS,WAAA,CAAY,SAAA,EAAW,KAAA,CAAM,EAAA,CAAG,CAAC,CAAA,EAAG,KAAA,CAAM,EAAA,CAAG,CAAC,CAAC,CAAA;AAC9D,EAAA,OAAO,MAAA,GAAS,WAAA;AAClB;AAEO,SAAS,oBAAoB,UAAA,EAA8B;AAChE,EAAA,MAAM,MAAA,GAAS,CAAC,MAAA,KACd,wBAAA,CAAyB,YAAY,MAAM,CAAA;AAE7C,EAAA,OAAO;AAAA,IACL,UAAA,EAAY,eAAe,UAAU,CAAA;AAAA,IACrC,SAAA,EAAW,OAAO,aAAa,CAAA;AAAA,IAC/B,WAAA,EAAa,OAAO,eAAe,CAAA;AAAA,IACnC,aAAA,EAAe,MAAA,CAAO,eAAA,GAAkB,IAAI,CAAA;AAAA,IAC5C,WAAA,EAAa,MAAA,CAAO,eAAA,GAAkB,IAAA,GAAO,CAAC,CAAA;AAAA,IAC9C,aAAA,EAAe,OAAO,iBAAiB;AAAA,GACzC;AACF","file":"chunk-7LUK7J7M.js","sourcesContent":["import { APCAcontrast, sRGBtoY } from \"apca-w3\";\nimport { converter } from \"culori\";\nimport type { Context, ModeSpec } from \"./types.ts\";\n\nconst toRgb = converter(\"rgb\");\n\n// Original toRgbTriplet implementation (no memoization)\nexport function toRgbTriplet(lightness: number): [number, number, number] {\n  const rgb = toRgb({ mode: \"oklch\", l: clamp01(lightness), c: 0, h: 0 });\n\n  const clampChannel = (value: number): number => {\n    const clamped = clamp01(value);\n    return Math.round(clamped * 255);\n  };\n\n  return [clampChannel(rgb.r), clampChannel(rgb.g), clampChannel(rgb.b)];\n}\n\n// Original contrastForPair implementation (no memoization)\nexport function contrastForPair(\n  foreground: number,\n  background: number\n): number {\n  const fgY = sRGBtoY(toRgbTriplet(foreground));\n  const bgY = sRGBtoY(toRgbTriplet(background));\n  const contrast = APCAcontrast(fgY, bgY);\n  const numeric = typeof contrast === \"number\" ? contrast : Number(contrast);\n\n  if (!Number.isFinite(numeric)) {\n    throw new Error(\n      `APCAcontrast returned a non-finite value for foreground ${foreground} and background ${background}.`\n    );\n  }\n\n  return Math.abs(numeric);\n}\n\n// --- CONSTANTS ---\n\nexport const CONTRAST_EPSILON = 0.005;\nexport const LIGHTNESS_PRECISION = 4;\n\nconst HIGH_CONTRAST = 108;\nconst STRONG_CONTRAST = 105;\nconst SUBTLEST_CONTRAST = 75;\nconst STEP = (STRONG_CONTRAST - SUBTLEST_CONTRAST) / 3;\n\n// --- UTILS ---\n\nexport function clamp01(value: number): number {\n  return clampTo(value, 0, 1);\n}\n\nexport function clampTo(value: number, min: number, max: number): number {\n  if (value < min) return min;\n  if (value > max) return max;\n  return value;\n}\n\nexport function roundLightness(value: number): number {\n  return Number(value.toFixed(LIGHTNESS_PRECISION));\n}\n\nexport function formatPrecision(value: number, digits = 4): number {\n  return Number(value.toFixed(digits));\n}\n\nexport const avg = (numbers: number[]): number => {\n  const total = numbers.reduce((sum, n) => sum + n, 0);\n  return total / numbers.length;\n};\n\n// --- BINARY SEARCH ---\n\nexport function binarySearch(\n  min: number,\n  max: number,\n  evaluate: (candidate: number) => number,\n  target: number,\n  epsilon: number = 0.005,\n  maxIterations: number = 40\n): number {\n  let low = min;\n  let high = max;\n\n  const valAtMin = evaluate(min);\n  const valAtMax = evaluate(max);\n  const slope = Math.sign(valAtMax - valAtMin) || 1;\n\n  const minVal = Math.min(valAtMin, valAtMax);\n  const maxVal = Math.max(valAtMin, valAtMax);\n\n  if (target <= minVal + epsilon) return valAtMin <= valAtMax ? min : max;\n  if (target >= maxVal - epsilon) return valAtMax >= valAtMin ? max : min;\n\n  for (let i = 0; i < maxIterations; i++) {\n    const mid = (low + high) / 2;\n    const val = evaluate(mid);\n    const delta = val - target;\n\n    if (Math.abs(delta) <= epsilon) {\n      return mid;\n    }\n\n    if (delta * slope > 0) {\n      high = mid;\n    } else {\n      low = mid;\n    }\n  }\n\n  return (low + high) / 2;\n}\n\n// --- CONTRAST ---\n\nexport function textLightness(context: Context): number {\n  const { polarity, mode } = context;\n  if (polarity === \"page\") {\n    return mode === \"light\" ? 0 : 1;\n  }\n  return mode === \"light\" ? 1 : 0;\n}\n\nexport function contrastForBackground(\n  context: Context,\n  background: number\n): number {\n  return contrastForPair(textLightness(context), background);\n}\n\nexport function backgroundBounds(start: number, end: number): [number, number] {\n  return [Math.min(start, end), Math.max(start, end)];\n}\n\nexport function clampContrast(context: Context, target: number): number {\n  const contrastAtZero = contrastForBackground(context, 0);\n  const contrastAtOne = contrastForBackground(context, 1);\n  const max = Math.max(contrastAtZero, contrastAtOne);\n  const min = Math.min(contrastAtZero, contrastAtOne);\n  if (target > max) return max;\n  if (target < min) return min;\n  return target;\n}\n\nexport function solveBackgroundForContrast(\n  context: Context,\n  targetContrast: number,\n  lowerBound: number,\n  upperBound: number\n): number {\n  const [minBg, maxBg] = backgroundBounds(lowerBound, upperBound);\n  const clampedTarget = clampContrast(context, targetContrast);\n\n  const result = binarySearch(\n    minBg,\n    maxBg,\n    (bg) => contrastForBackground(context, bg),\n    clampedTarget,\n    CONTRAST_EPSILON\n  );\n\n  return roundLightness(result);\n}\n\nexport function solveForegroundLightness(\n  background: number,\n  targetContrast: number\n): number {\n  const contrastLighter = contrastForPair(1, background);\n  const contrastDarker = contrastForPair(0, background);\n  const preferLighter = contrastLighter >= contrastDarker;\n\n  const range: [number, number] = preferLighter\n    ? [background, 1]\n    : [0, background];\n\n  const result = binarySearch(\n    range[0],\n    range[1],\n    (fg) => contrastForPair(fg, background),\n    targetContrast,\n    0.0001\n  );\n\n  return formatPrecision(clamp01(result));\n}\n\nexport function solveBorderAlpha(\n  surfaceL: number,\n  textL: number,\n  targetContrast: number\n): number {\n  return binarySearch(\n    0,\n    1,\n    (alpha) => {\n      const borderL = textL * alpha + surfaceL * (1 - alpha);\n      return contrastForPair(borderL, surfaceL);\n    },\n    targetContrast,\n    0.01\n  );\n}\n\n// --- HUE SHIFT ---\n\nfunction cubicBezier(t: number, p1: number, p2: number): number {\n  const oneMinusT = 1 - t;\n  return (\n    3 * oneMinusT * oneMinusT * t * p1 + 3 * oneMinusT * t * t * p2 + t * t * t\n  );\n}\n\nexport function calculateHueShift(\n  lightness: number,\n  config?: {\n    curve: { p1: [number, number]; p2: [number, number] };\n    maxRotation: number;\n  }\n): number {\n  if (!config) return 0;\n  const { curve, maxRotation } = config;\n  const factor = cubicBezier(lightness, curve.p1[1], curve.p2[1]);\n  return factor * maxRotation;\n}\n\nexport function solveForegroundSpec(background: number): ModeSpec {\n  const solver = (target: number): number =>\n    solveForegroundLightness(background, target);\n\n  return {\n    background: roundLightness(background),\n    \"fg-high\": solver(HIGH_CONTRAST),\n    \"fg-strong\": solver(STRONG_CONTRAST),\n    \"fg-baseline\": solver(STRONG_CONTRAST - STEP),\n    \"fg-subtle\": solver(STRONG_CONTRAST - STEP * 2),\n    \"fg-subtlest\": solver(SUBTLEST_CONTRAST),\n  };\n}\n"]}