# System Intuition: How It Works

This document explains the "Mental Model" of the Color System. It bridges the gap between the high-level goals and the low-level implementation.

## 1. The Philosophy: Math, Not Magic

Most color systems are **Static Palettes**. You pick 50 shades of blue, name them `blue-100` to `blue-900`, and hope they work together.

This system is a **Dynamic Engine**. You define **Intent** (e.g., "I need a Card surface"), and the system **Solves** for the color that guarantees accessibility and harmony.

### The Solver

At build time (or runtime), the Solver takes your configuration (Anchors, Key Colors) and uses binary search to find the exact lightness value that meets contrast targets.

- **Input**: "I want a 'Card' surface on a 'Page' background."
- **Solver**: "The Page is L=98. To get a decorative border, the Card needs L=96. To get readable text, the text needs L=20."
- **Output**: A set of CSS Variables (Tokens).

**You don't think about the math.** You just use the components, and the system ensures they work.

## 2. The Token Taxonomy

To make this dynamic system work, we distinguish between three types of tokens:

### A. Input Tokens (The Context)

These are the "knobs" that control the theme. They are usually set on `:root` or by modifier classes.

- `--base-hue`: The current hue (e.g., Brand Red).
- `--base-chroma`: The current vibrancy.

### B. Intermediate Tokens (The Recipe)

These are generated by the Solver. They are **not colors**; they are instructions containing the calculated Lightness (L) and Hue Shift (H).

- `--surface-token`: "Be L=96 with a +2 hue shift."
- `--text-high-token`: "Be L=20 with no hue shift."

### C. Computed Tokens (The Output)

These are the final colors used in CSS properties. The browser calculates them by combining the **Recipe** with the **Context**.

- `--computed-surface`: `oklch(96% 0.01 25)` (Result of combining L=96 with Context Chroma and Hue).
- `--computed-fg-color`: The final text color.

## 3. The Reactive Pipeline (`base.css`)

The generated tokens are not final colors. They are **Inputs** to a reactive pipeline running in the browser's CSS engine.

We use modern CSS features (`@property`, `calc()`, `oklch()`) to create a system that adapts instantly to context.

### The Pipeline Steps

1.  **Context Injection**: When you apply a class like `.surface-card`, you are setting a `--surface-token` (The Recipe).
2.  **Deconstruction**: The system extracts the Lightness (L) and Hue Shift (H) from that token.
3.  **Reconstruction**: It combines those values with the current **Context** (Brand Hue, Chroma) to generate the final color.

```css
--computed-surface: oklch(
  from var(--surface-token) l /* 1. Take Lightness from Solver */ var(
      --computed-surface-C
    )
    /* 2. Apply Context Chroma */ calc(var(--base-hue) + h) /* 3. Apply Context Hue + Shift */
);
```

This means if you change `--base-hue` (e.g., by adding `.hue-brand`), **every surface and text element instantly updates** to match the new hue, while maintaining the Solver's lightness guarantees.

## 4. The Taxonomy

The system is built on **Semantic Roles**, not visual descriptions.

### Surfaces (The Container)

- **Page**: The infinite backdrop.
- **Workspace**: A dedicated area for content.
- **Card**: A contained, distinct element.
- **Action**: An interactive element (button).

### Text (The Content)

- **High**: The primary content. Maximum contrast.
- **Subtle**: Secondary content. Reduced contrast, but still accessible.
- **Subtlest**: Meta-data. Minimum accessible contrast.

### Modifiers (The Intent)

- **Hue**: `.hue-brand`, `.hue-success`. Changes the "Soul" of the color.
- **State**: `.state-disabled`, `.state-selected`. Changes the interaction status.

## 5. Runtime Portability

Because the logic is split between the **Solver** (Math) and the **Pipeline** (CSS), we can run the Solver in the browser!

The `color-system/runtime` module allows you to generate a full theme from a brand color on the fly. This is how the "Fearless Injector" demo works.

```typescript
import { generateTheme, injectTheme } from "color-system/runtime";

const css = generateTheme({
  anchors: { ... },
  keyColors: { brand: "#ff0000" }
});

// Inject and update later
const style = injectTheme(css);
// ... later ...
injectTheme(newCss, undefined, style); // Updates the existing tag
```
