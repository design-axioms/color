/*
   BASELINE 2025: GRAND UNIFIED ALGEBRA v4.0
   The core logic for the "Reactive Pipeline".
*/

/* --- 1. STATE TUPLE DEFINITIONS --- */

/* Time (Tau) */
@property --tau {
  syntax: "<number>";
  initial-value: 1;
  inherits: true;
}

/* Atmosphere (Alpha) */
/* Alpha = Atmosphere: The environmental context (Hue/Chroma) */
@property --alpha-hue {
  syntax: "<number>";
  initial-value: 0;
  inherits: true;
}

@property --alpha-beta {
  syntax: "<number>"; /* Vibrancy Coefficient (Chroma) */
  initial-value: 0.008;
  inherits: true;
}

/* Structure (For X-Ray Mode) */
@property --alpha-structure {
  syntax: "*";
  inherits: true;
  initial-value: 1px solid CanvasText;
}
/* Note: @property doesn't support complex border syntax well. We'll rely on var() fallback for structure. */

/* Voice (Nu) - Handled via Tokens */

/* Gain (Gamma) - Handled via Media Query */

/* System (Sigma) - Handled via Media Query */

/* --- 2. INTERNAL VARIABLES (The Engine) --- */

@property --_axm-computed-surface {
  syntax: "<color>";
  inherits: true;
  initial-value: transparent;
}

@property --_axm-computed-fg-color {
  syntax: "<color>";
  inherits: true;
  initial-value: transparent;
}

@property --_axm-computed-surface-C {
  syntax: "<number>";
  inherits: true;
  initial-value: 0;
}

@property --_axm-computed-fg-C {
  syntax: "<number>";
  inherits: true;
  initial-value: 0;
}

/* --- 2b. BRIDGE EXPORTS (Integration Adapters) --- */

@property --axm-bridge-surface {
  syntax: "<color>";
  inherits: true;
  initial-value: transparent;
}

@property --axm-bridge-fg {
  syntax: "<color>";
  inherits: true;
  initial-value: transparent;
}

@property --axm-bridge-fg-high {
  syntax: "<color>";
  inherits: true;
  initial-value: transparent;
}

@property --axm-bridge-fg-body {
  syntax: "<color>";
  inherits: true;
  initial-value: transparent;
}

@property --axm-bridge-fg-subtle {
  syntax: "<color>";
  inherits: true;
  initial-value: transparent;
}

@property --axm-bridge-border-dec {
  syntax: "<color>";
  inherits: true;
  initial-value: transparent;
}

@property --axm-bridge-border-int {
  syntax: "<color>";
  inherits: true;
  initial-value: transparent;
}

/* --- 3. ROOT CONFIGURATION --- */

:root {
  color-scheme: light dark;

  /* Initialize Time */
  --tau: 1; /* Day Mode by default */

  /* Public Shadow Aliases */
  --shadow-sm: var(--axm-shadow-sm);
  --shadow-md: var(--axm-shadow-md);
  --shadow-lg: var(--axm-shadow-lg);
  --shadow-xl: var(--axm-shadow-xl);

  /* Animate Time (gated): avoid boot-time animate-in as CSS loads */
  transition: none;
}

/* Enable tau transitions only after an integration marks the page as ready.
   ThemeManager sets `data-axm-ready="true"` after the initial sync. */
:root[data-axm-ready="true"] {
  transition: --tau 0.3s ease-in-out;
}

/* ThemeManager semantic state (steady-state driver) */
:root[data-axm-resolved-mode="light"] {
  --tau: 1;
}

:root[data-axm-resolved-mode="dark"] {
  --tau: -1;
}

/* Fallback for pre-init pages (no semantic state yet) */
@media (prefers-color-scheme: dark) {
  :root:not([data-axm-resolved-mode]) {
    --tau: -1; /* Night Mode */
  }
}

/* Proxy tokens that cascade from utilities */
@property --axm-surface-token {
  syntax: "<color>";
  inherits: true;
  initial-value: transparent;
}

@property --axm-text-high-token {
  syntax: "<color>";
  inherits: true;
  initial-value: transparent;
}

@property --axm-text-subtle-token {
  syntax: "<color>";
  inherits: true;
  initial-value: transparent;
}

@property --axm-text-subtlest-token {
  syntax: "<color>";
  inherits: true;
  initial-value: transparent;
}

@property --axm-border-dec-token {
  syntax: "<color>";
  inherits: true;
  initial-value: transparent;
}

@property --axm-border-int-token {
  syntax: "<color>";
  inherits: true;
  initial-value: transparent;
}

/* --- 4. THE ALGEBRA (Resolution Function) --- */

:where(
  [class^="surface-"],
  [class*=" surface-"],
  [class^="text-"],
  [class*=" text-"],
  body
) {
  /* --- TEXT RESOLUTION (Voice) --- */

  /* 1. Source Selection */
  --_axm-text-lightness-source: var(--axm-text-high-token);

  /* 2. Chroma Calculation */
  /* Text inherits 50% of the ambient vibrancy */
  --_axm-computed-fg-C: calc(var(--alpha-beta) * 0.5);

  /* Adapter-safe duplicate (avoid aliasing private computed vars in exports). */
  --_axm-bridge-fg-C: calc(var(--alpha-beta) * 0.5);

  /* 3. Reify Color with HK Buffer */
  /* L_target = L_source + (0.05 * Beta) */
  --_axm-computed-fg-color: oklch(
    from var(--_axm-text-lightness-source)
      calc(l + (0.05 * var(--_axm-computed-fg-C))) var(--_axm-computed-fg-C)
      var(--alpha-hue)
  );

  /* Bridge exports (public, adapter-safe) */
  /*
     NOTE: Do not alias computed colors via `var(--_axm-...)` here.
     Chromium can fail to invalidate dependent custom properties consistently.
     Compute directly from the same inputs so adapters see stable values.
  */
  --axm-bridge-fg: oklch(
    from var(--_axm-text-lightness-source)
      calc(l + (0.05 * var(--_axm-bridge-fg-C))) var(--_axm-bridge-fg-C)
      var(--alpha-hue)
  );

  /* Semantic bridge exports (text-role variants) */
  --axm-bridge-fg-high: oklch(
    from var(--axm-text-high-token) calc(l + (0.05 * var(--_axm-bridge-fg-C)))
      var(--_axm-bridge-fg-C) var(--alpha-hue)
  );
  --axm-bridge-fg-body: oklch(
    from var(--axm-text-body-token) calc(l + (0.05 * var(--_axm-bridge-fg-C)))
      var(--_axm-bridge-fg-C) var(--alpha-hue)
  );
  --axm-bridge-fg-subtle: oklch(
    from var(--axm-text-subtle-token) calc(l + (0.05 * var(--_axm-bridge-fg-C)))
      var(--_axm-bridge-fg-C) var(--alpha-hue)
  );

  color: var(--_axm-computed-fg-color);

  /* --- BORDER RESOLUTION --- */

  /* Decorative */
  --_axm-computed-border-dec-color: oklch(
    from var(--axm-border-dec-token) l var(--_axm-computed-fg-C)
      var(--alpha-hue) / alpha
  );

  /* Interactive */
  --_axm-computed-border-int-color: oklch(
    from var(--axm-border-int-token) l var(--_axm-computed-fg-C)
      var(--alpha-hue) / alpha
  );

  /* Bridge exports (public, adapter-safe) */
  --axm-bridge-border-dec: oklch(
    from var(--axm-border-dec-token) l var(--_axm-computed-fg-C)
      var(--alpha-hue) / alpha
  );
  --axm-bridge-border-int: oklch(
    from var(--axm-border-int-token) l var(--_axm-computed-fg-C)
      var(--alpha-hue) / alpha
  );

  border-color: var(--_axm-computed-border-dec-color);
}

/* --- SURFACE RESOLUTION (Physics) --- */

:where([class^="surface-"], [class*=" surface-"], body) {
  /* 
     We calculate the surface color using Relative Color Syntax (RCS).
     We extract 'l' and 'h' from the source token, and calculate 'c' (Chroma)
     based on the "Safe Bicone" physics model.
     
     Model:
     x = 2L - 1  (Lightness mapped to -1..1)
     taper = 1 - abs(x) (Chroma availability based on lightness)
     tunnel = tau^2 (Time dilation)
     limit = beta * taper * tunnel
     C = min(beta, limit)
  */

  /*
     NOTE: We intentionally avoid `oklch(from var(--axm-surface-token) ...)`.
     Chromium currently fails to consistently invalidate recomputation when the
     `var(--axm-surface-token)` value changes (e.g. theme flips via `--tau`).
     Instead, compute the surface channels directly from the per-surface light/dark
     endpoints which are already generated into theme CSS.
  */

  --_axm-surface-L: calc(
    var(--_axm-local-light-l) +
      (var(--_axm-local-dark-l) - var(--_axm-local-light-l)) *
      var(--_axm-mode-mix)
  );

  --_axm-computed-surface: oklch(
    var(--_axm-surface-L)
      min(
        var(--alpha-beta),
        var(--alpha-beta) * (1 - abs(2 * var(--_axm-surface-L) - 1)) *
          var(--tau) * var(--tau)
      )
      var(--alpha-hue)
  );

  /* Bridge exports (public, adapter-safe) */
  --axm-bridge-surface: oklch(
    var(--_axm-surface-L)
      min(
        var(--alpha-beta),
        var(--alpha-beta) * (1 - abs(2 * var(--_axm-surface-L) - 1)) *
          var(--tau) * var(--tau)
      )
      var(--alpha-hue)
  );

  background-color: var(--_axm-computed-surface);
  scrollbar-color: var(--axm-text-subtle-token) var(--axm-surface-token);
}

/* --- TRANSITIONS --- */

/* Motion policy:
   - Default: allow output transitions for discrete surface/token changes.
   - `data-axm-motion="tau"`: disable output transitions so only `--tau` drives motion.
*/
:root:not([data-axm-motion="tau"])
  :where(
    [class^="surface-"],
    [class*=" surface-"],
    [class^="state-"],
    [class*=" state-"],
    [class^="text-"],
    [class*=" text-"]
  ) {
  transition:
    --_axm-computed-surface 0.2s ease-in-out,
    --_axm-computed-fg-color 0.2s ease-in-out,
    --_axm-computed-border-dec-color 0.2s ease-in-out,
    --_axm-computed-border-int-color 0.2s ease-in-out,
    --axm-bridge-surface 0.2s ease-in-out,
    --axm-bridge-fg 0.2s ease-in-out,
    --axm-bridge-border-dec 0.2s ease-in-out,
    --axm-bridge-border-int 0.2s ease-in-out;
}

/* --- UTILITIES --- */

.shadow-sm {
  box-shadow: var(--shadow-sm);
}
.shadow-md {
  box-shadow: var(--shadow-md);
}
.shadow-lg {
  box-shadow: var(--shadow-lg);
}
.shadow-xl {
  box-shadow: var(--shadow-xl);
}

.bordered {
  border-width: 1px;
  border-style: solid;
}

:focus-visible {
  outline: 2px solid
    oklch(from var(--_axm-computed-fg-color) l 0.2 var(--alpha-hue));
  outline-offset: 2px;
}

mark,
::selection {
  background-color: var(--axm-highlight-surface-color);
  color: var(--axm-text-high-token);
}

/* --- X-RAY MODE (Forced Colors) --- */

@media (forced-colors: active) {
  :root {
    --_axm-computed-surface: Canvas;
    --_axm-computed-fg-color: CanvasText;
  }

  /* The Hollow State: Map Atmosphere to Structure */
  .surface-card,
  .surface-workspace,
  .surface-tinted,
  .surface-spotlight,
  .surface-soft-spotlight {
    /* Disable Physics */
    background-color: Canvas;
    color: CanvasText;

    /* Enable Structure */
    /* Use the structural fallback defined by the Mood */
    border: var(--alpha-structure, 1px solid CanvasText);
  }

  .surface-action {
    background-color: ButtonFace;
    color: ButtonText;
    border: 1px solid ButtonText;
  }

  .text-link {
    color: LinkText;
  }

  .state-disabled,
  [disabled] {
    color: GrayText;
    border-color: GrayText;
  }

  .state-selected,
  [aria-selected="true"] {
    background-color: Highlight;
    color: HighlightText;
    border-color: Highlight;
  }

  ::selection {
    background-color: Highlight;
    color: HighlightText;
  }

  :focus-visible {
    outline-color: Highlight;
  }
}

/* --- PRINT --- */

@media print {
  :root {
    color-scheme: light;
    --alpha-beta: 0;
    --tau: 1;
  }

  .surface-card,
  .surface-workspace,
  .surface-tinted {
    background-color: white;
    border: 1px solid var(--axm-text-subtlest-token);
  }

  body {
    color: black;
  }
  .surface-action {
    display: none;
  }
}
